---
title: "Build Geojson"
author: "Justin Betts"
date: "2024-04-20"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library( geojsonio )   # read shapefiles
library( sp )          # work with shapefiles
library( sf )          # work with shapefiles - simple features format
library( mclust )      # cluster analysis 
library( tmap )        # theme maps
library( ggplot2 )     # graphing 
library( ggthemes )    # nice formats for ggplots
library( dplyr )       # data wrangling 
library( pander )      # formatting RMD tables
library( tidycensus )  # census data
library( cartogram ) 
```

```{r cache get_acs() data}
options(tigris_use_cache = T)
```

```{r load crosswalk data}
crosswalk <- read.csv( "https://raw.githubusercontent.com/DS4PS/cpp-529-master/master/data/cbsatocountycrosswalk.csv",  stringsAsFactors=F, colClasses="character" )

# search for cities names by strings, use the ^ anchor for "begins with" 

grep( "^SAN DIEGO", crosswalk$msaname, value=TRUE ) 
```

```{r select FIPS for San Diego}
# Need to adjust this for my city later
these.msp <- crosswalk$msaname == "SAN DIEGO, CA"
these.fips <- crosswalk$fipscounty[ these.msp ]
these.fips <- na.omit( these.fips )
```

```{r confirm states & counties for metro}
state.fips <- substr( these.fips, 1, 2 )
county.fips <- substr( these.fips, 3, 5 )

cbind( these.fips, state.fips, county.fips )
```

```{r load San Diego population}
# Need to adjust this for my city later
cityp.pop <-
get_acs( geography = "tract", variables = "B01003_001",
         state = "06", county = county.fips[state.fips=="06"], geometry = TRUE ) %>% 
         dplyr::select( GEOID, estimate ) %>%
         rename( POP=estimate )
```

```{r remove leading 0}
# Potentially remove this with my city
cityp.pop$GEOID <- as.numeric( sub( "^0+", "", cityp.pop$GEOID ) )
```

```{r add LTDB data}
URL <- "https://github.com/DS4PS/cpp-529-master/raw/master/data/ltdb_std_2010_sample.rds"
census.dat <- readRDS(gzcon(url( URL )))

# can merge an sf object and data.frame
cityp <- merge( cityp.pop, census.dat, by.x="GEOID", by.y="tractid" )

# make sure there are no empty polygons
cityp <- cityp[ ! st_is_empty( cityp ) , ]
```

```{r data dictionary, eval=FALSE}
data.dictionary <- 
structure(list(LABEL = c("tractid", "pnhwht12", "pnhblk12", "phisp12", 
"pntv12", "pfb12", "polang12", "phs12", "pcol12", "punemp12", 
"pflabf12", "pprof12", "pmanuf12", "pvet12", "psemp12", "hinc12", 
"incpc12", "ppov12", "pown12", "pvac12", "pmulti12", "mrent12", 
"mhmval12", "p30old12", "p10yrs12", "p18und12", "p60up12", "p75up12", 
"pmar12", "pwds12", "pfhh12"), VARIABLE = c("GEOID", "Percent white, non-Hispanic", 
"Percent black, non-Hispanic", "Percent Hispanic", "Percent Native American race", 
"Percent foreign born", "Percent speaking other language at home, age 5 plus", 
"Percent with high school degree or less", "Percent with 4-year college degree or more", 
"Percent unemployed", "Percent female labor force participation", 
"Percent professional employees", "Percent manufacturing employees", 
"Percent veteran", "Percent self-employed", "Median HH income, total", 
"Per capita income", "Percent in poverty, total", "Percent owner-occupied units", 
"Percent vacant units", "Percent multi-family units", "Median rent", 
"Median home value", "Percent structures more than 30 years old", 
"Percent HH in neighborhood 10 years or less", "Percent 17 and under, total", 
"Percent 60 and older, total", "Percent 75 and older, total", 
"Percent currently married, not separated", "Percent widowed, divorced and separated", 
"Percent female-headed families with children")), class = "data.frame", row.names = c(NA, 
-31L))
```

```{r convert sf to sp}
cityp.sp <- as_Spatial( cityp )
```

```{r remove empty tracts}
# project map and remove empty tracts
cityp.sp <- spTransform( cityp.sp, CRS("+init=epsg:3395"))
cityp.sp <- cityp.sp[ cityp.sp$POP != 0 & (! is.na( cityp.sp$POP )) , ]
# convert census tract polygons to dorling cartogram
# no idea why k=0.03 works, but it does - default is k=5
cityp.sp$pop.w <- cityp.sp$POP / 9000 # max(msp.sp$POP)   # standardizes it to max of 1.5
cityp_dorling <- cartogram_dorling( x=cityp.sp, weight="pop.w", k=0.05 )

d1 <- cityp_dorling@data

```

```{r}
class( cityp_dorling)
```

```{r}
keep.these <- c("pnhwht12", "pnhblk12", "phisp12", "pntv12", "pfb12", "polang12", 
"phs12", "pcol12", "punemp12", "pflabf12", "pprof12", "pmanuf12", 
"pvet12", "psemp12", "hinc12", "incpc12", "ppov12", "pown12", 
"pvac12", "pmulti12", "mrent12", "mhmval12", "p30old12", "p10yrs12", 
"p18und12", "p60up12", "p75up12", "pmar12", "pwds12", "pfhh12")

d2 <- select( d1, keep.these )
d3 <- apply( d2, 2, scale )
```


```{r}
set.seed( 1234 )
fit <- Mclust( d3 )
cityp_dorling$cluster <- as.factor( fit$classification )
summary( fit )
```

```{r}
URL1 <- "https://github.com/DS4PS/cpp-529-fall-2020/raw/main/LABS/data/rodeo/LTDB-2000.rds"
d1 <- readRDS( gzcon( url( URL1 ) ) )

URL2 <- "https://github.com/DS4PS/cpp-529-fall-2020/raw/main/LABS/data/rodeo/LTDB-2010.rds"
d2 <- readRDS( gzcon( url( URL2 ) ) )

URLmd <- "https://github.com/DS4PS/cpp-529-fall-2020/raw/main/LABS/data/rodeo/LTDB-META-DATA.rds"
md <- readRDS( gzcon( url( URLmd ) ) )

d1 <- select( d1, - year )
d2 <- select( d2, - year )

d <- merge( d1, d2, by="tractid" )
d <- merge( d, md, by="tractid" )

d <- 
  d %>%
  mutate( # percent white in 2000
          p.white.00 = 100 * nhwht00 / pop00.x,
          # percent black in 2000
          p.black.00 = 100 * nhblk00 / pop00.x,
          # percent hispanic in 2000
          p.hisp.00 = 100 * hisp00 / pop00.x, 
          # percent asian in 2000
          p.asian.00 = 100 * asian00 / pop00.x,
          # percent high school grads by age 25 in 2000 
          p.hs.00 = 100 * (hs00+col00) / ag25up00,
          # percent pop with college degree in 2000
          p.col.00 = 100 * col00 / ag25up00,
          # percent employed in professional fields in 2000
          p.prof.00 = 100 * prof00 / empclf00,
          # percent unemployment  in 2000
          p.unemp.00 = 100 * unemp00 / clf00,
          # percent of housing lots in tract that are vacant in 2000
          p.vacant.00 = 100 * vac00 / hu00,
          # dollar change in median home value 2000 to 2010 
          pov.rate.00 = 100 * npov00 / dpov00 )

# adjust 2000 home values for inflation 
mhv.00 <- d$mhmval00 * 1.28855  
mhv.10 <- d$mhmval12

# change in MHV in dollars
mhv.change <- mhv.10 - mhv.00


# drop low 2000 median home values
# to avoid unrealistic growth rates.
#
# tracts with homes that cost less than
# $1,000 are outliers
mhv.00[ mhv.00 < 1000 ] <- NA

# change in MHV in percent
mhv.growth <- 100 * ( mhv.change / mhv.00 )

d$mhv.00 <- mhv.00
d$mhv.10 <- mhv.10
d$mhv.change <- mhv.change
d$mhv.growth <- mhv.growth 

# STANDARDIZE GEO IDs

# note the current geoid format for the LTDB census data: 
# FIPS-STATE-COUNTY-TRACT:  fips-01-001-020100  

x <- d$tractid 
# head( x )
# [1] "fips-01-001-020100" "fips-01-001-020200" "fips-01-001-020300"
# [4] "fips-01-001-020400" "fips-01-001-020500" "fips-01-001-020600"

# remove non-numeric strings 
x <- gsub( "fips", "", x )
x <- gsub( "-", "", x )
# head( x )
# [1] "01001020100" "01001020200" "01001020300" "01001020400" "01001020500"
# [6] "01001020600"

# drop leading zeros 
x <- as.numeric( x )

# head(x)

# remember to add the variable back to the census dataset
d$tractid2 <- x 

cityp_dorling <- merge( cityp_dorling, d, by.x="GEOID", by.y="tractid2", all.x=T )
```

```{r eval=FALSE}
keep.these <- c("nhwht00", "nhblk00", "hisp00", "ntv00", "fb00", "olang00", "hs00", "col00", "unemp00", 
"flabf00", "prof00", "manuf00", "vet00", "semp00", "hinc00", 
"incpc00", "dpov00", "own00", "vac00", "multi00", "mrent00", 
"mhmval00", "h30old00", "h10yrs00", "a18und00", "a60up00", "a75up00", 
"mar00", "wds00", "fhh00")

d2 <- select( d1, keep.these )
d3 <- apply( d2, 2, scale )
```

```{r}
# data frame and polygon ID standardization in case a tract was dropped and IDs don't match
row.ids <- sapply( slot( cityp_dorling, "polygons" ), function(x) slot( x, "ID" ) )
row.names( cityp_dorling ) <- row.ids

# project to standard lat-lon coordinate system 
cityp_dorling <- spTransform( cityp_dorling, CRS("+proj=longlat +datum=WGS84") )

# write to file 
geojson_write( cityp_dorling, file="sandy_dorling.geojson", geometry="polygon" )

```